name: Deploy ADF LinkedService

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      AZURE_CLIENT_ID:
        required: true
        type: string
      AZURE_CLIENT_SECRET:
        required: true
        type: string
      AZURE_SUBSCRIPTION_ID:
        required: true
        type: string
      AZURE_TENANT_ID:
        required: true
        type: string

env: 
  keyVaultName: 'kx1-demo-dev'
  connectionSecretName: 'kx-demo-constring-dev'
  credentialSecretName: 'kx-demo-cred-dev'

jobs:
  
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install jq
      run: sudo apt-get install jq

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: >
              {
                "clientId":"${{ inputs.AZURE_CLIENT_ID }}",
                "clientSecret":"${{ inputs.AZURE_CLIENT_SECRET }}",
                "subscriptionId":"${{ inputs.AZURE_SUBSCRIPTION_ID }}",
                "tenantId":"${{ inputs.AZURE_TENANT_ID }}"
              }
        enable-AzPSSession: true

    - name: Read Linked Service Dependencies
      run: |
          echo "LINKED_SERVICES_DEPENDENCIES=$(cat linkedServicesDependencies.json)" >> $GITHUB_ENV

    - name: Deploy Linked Services in Order
      run: |
        linked_services='${{ env.LINKED_SERVICES_DEPENDENCIES }}'
        deployed=()

        deploy_linked_service() {
          local linked_service=$1
          if [[ " ${deployed[@]} " =~ " $linked_service " ]]; then
            echo "$linked_service already deployed."
            return
          fi
          # Deploy dependencies first
          for dep in $(echo $linked_services | jq -r ".[\"$linked_service\"][]"); do
            deploy_linked_service $dep
          done
          echo "Deploying Linked Service: $linked_service..."
          az datafactory linked-service create --factory-name komatsu-test-poc --resource-group komatsu-poc \
            --name $linked_service --json-file "linkedService/$linked_service.json"
          deployed+=("$linked_service")
        }

        for linked_service in $(echo $linked_services | jq -r 'keys[]'); do
          deploy_linked_service $linked_service
        done
          